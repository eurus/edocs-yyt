---
layout: page
title: "密码键盘"
category: hardware
date: 2014-04-04 10:45:19
order: 3
---

### 原理

密码键盘中有8个分区（Section，00-08），每个区有4个位置（00-03），每个位置可以存储一个十六进制的KEY（32位）。密码键盘内部适用3DES加密和解密方式，默认使用32位的密钥。对于16位密钥的处理方式，就是把密钥重复一遍补齐32位。

密码键盘相关的密钥共有3把：

* 主密钥（Main Key或Master Key）
* 工作密钥（PIN Key）
* MAC密钥（MAC Key）

#### 术语

* 明文（plain text）表示内容是直白的，直接可以使用的内容
* 密文（cipher text）表示内容是加过密的，需解密后才可使用的内容
* MAC（Message Authentication Code）消息检验码，用于确保在网络上传输的内容不会被人改动
* PIN Block 是通过密码键盘加密之后的密码

### 灌主密钥

主密钥是用于更新工作密钥的唯一密钥，与终端号有关，一般来说，不同的终端号对应不同的主密钥。

主密钥一般由银行提供，且提供时一般是密文，需要专门的灌密钥工具进行解密后存储到相应位置，一般主密钥存放位置为0区0号。例如：交行的主密钥由三部分组成：密钥分量1、密钥分量2、检验码，其各自的作用如下：

1. 密钥分量1和密钥分量2通过一次异或获取主密钥明文，如为16位，需重复一遍至32位
2. 使用主密钥明文加密32个0，得到的密文前6位应该与检验码完全相同

注意：
**主密钥默认为32个0**

### 更新工作密钥

更新工作密钥时，需从银行方获取PIN Key和MAC Key的密文，然后调用密码键盘相应接口，密码键盘会自动解密（3DES）并将密钥存储以便以后使用。

注意：
**即使灌主密钥不成功，更新工作密钥总是会成功**

### 计算PIN BLOCK

调用密码键盘输入后，会有加密之后的密文输出。

### 模拟程序

该模拟程序给出了一个SNK088A-JSGG-E12-A02的软件模拟

{% highlight java %}

{% endhighlight %}


### 常用硬件指令

#### 版本切换

切换至工行版（统一默认版）

    1b 99 00 0d 0a

切换至浦发版（参数为01，或02浦发移动版）
    
    1b 99 01 0d 0a

#### 查看主密钥

查看0区主密钥

    1b 44 00 0d 0a

查看1区主密钥

    1b 44 01 0d 0a

#### 查看工作密钥

查看0区第一个工作密钥位置

    1b 44 00 00 0d 0a

查看0区第二个工作密钥位置

    1b 44 00 01 0d 0a

## 灌主密钥

    1b 62 00 <主密钥32位hex> 0d 0a
